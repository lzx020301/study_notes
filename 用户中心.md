# è§„èŒƒåŒ–çš„ç”¨æˆ·ä¸­å¿ƒå¼€å‘

> æ­¤ç³»ç»Ÿæ—¨åœ¨å®Œæˆä¸€å¥—è§„èŒƒåŒ–çš„ï¼Œæ˜“äºæ‰©å±•çš„ç”¨æˆ·ä¸­å¿ƒé¡¹ç›®ï¼Œæ­¤é¡¹ç›®å¯ä»¥ä½œä¸ºå„ä¸ªé¡¹ç›®çš„åå°ç³»ç»Ÿ

## æŠ€æœ¯é€‰å‹

å‰ç«¯ï¼šAnt Design Pro

åç«¯ï¼šSpringBoot + SSM + MyBatisPlus

## åˆå§‹åŒ–é¡¹ç›®

### å‰ç«¯åˆå§‹åŒ–

```bash
E:\é¡¹ç›®æ–‡ä»¶\ç”¨æˆ·ä¸­å¿ƒ>pro create myapp
? ğŸ‚ ä½¿ç”¨ umi@4 è¿˜æ˜¯ umi@3 ? umi@3
? ğŸš€ è¦å…¨é‡çš„è¿˜æ˜¯ä¸€ä¸ªç®€å•çš„è„šæ‰‹æ¶? simple
> clone repo url: https://gitee.com/ant-design/ant-design-pro
Cloning into 'myapp'...
remote: Enumerating objects: 208, done.
remote: Counting objects: 100% (208/208), done.
remote: Compressing objects: 100% (180/180), done.
remote: Total 208 (delta 33), reused 116 (delta 23), pack-reused 0Receiving objects:  88% (184/208)
Receiving objects: 100% (208/208), 118.44 KiB | 310.00 KiB/s, done.
Resolving deltas: 100% (33/33), done.
> ğŸšš clone success
> Clean up...

No change to package.json was detected. No package manager install will be executed.
```

> è¿›å…¥é¡¹ç›®æ‰§è¡Œyarnå‘½ä»¤æˆ–è€…npm installå‘½ä»¤å®‰è£…å¯¹åº”çš„ä¾èµ–

> æ¥ä¸‹æ¥ä½¿ç”¨æ‰§è¡Œstartå¯åŠ¨è„šæœ¬ï¼Œè¿è¡Œå‰ç«¯é¡¹ç›®

![image-20230423104013887-1682217621921-1](http://pic.user-center.xyz/images/2023/05/06/image-20230423104013887-1682217621921-1.png)

![image-20230423103936467](http://pic.user-center.xyz/images/2023/05/06/image-20230423103936467.png)

> å¼€å¯umi uiï¼Œè‡ªåŠ¨ç”Ÿæˆç•Œé¢
>
> yarn add @umijs/preset-ui -D

![image-20230423104401202-1682217844640-3](http://pic.user-center.xyz/images/2023/05/06/image-20230423104401202-1682217844640-3.png)

> æ³¨æ„è¿™ä¸€æ­¥ï¼Œéœ€è¦å¼€å¯æ¢¯å­è¿›è¡Œæ·»åŠ é¡µé¢ï¼Œå› ä¸ºå…¶æœ¬è´¨å°±æ˜¯ä»githubä¸Šæ‹‰å–ä»£ç 

![image-20230423111537718](http://pic.user-center.xyz/images/2023/05/06/image-20230423111537718.png)



****

### åç«¯åˆå§‹åŒ–

> ä½¿ç”¨ideaåˆ›å»ºSpringBooté¡¹ç›®

![image-20230423115251014-1682221973732-5](http://pic.user-center.xyz/images/2023/05/06/image-20230423115251014-1682221973732-5.png)

```xml
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.mybatis.spring.boot</groupId>
            <artifactId>mybatis-spring-boot-starter</artifactId>
            <version>2.3.0</version>
        </dependency>
        <!--çƒ­éƒ¨ç½²-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <!--æ•°æ®åº“è¿æ¥-->
        <dependency>
            <groupId>com.mysql</groupId>
            <artifactId>mysql-connector-j</artifactId>
            <scope>runtime</scope>
        </dependency>
        <!--æ•°æ®å±‚æ¡†æ¶-->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
            <version>3.5.2</version>
        </dependency>
        <!--é…ç½®æ–‡ä»¶æ³¨é‡Š-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-configuration-processor</artifactId>
            <optional>true</optional>
        </dependency>
        <!--å·¥å…·ç±»-->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <!--æµ‹è¯•-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
```

> ç¼–å†™ymlé…ç½®æ–‡ä»¶

```yaml
spring:
  application:
    name: usercenter-backend
  # é…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/user_center_backend
    username: root
    password: root
server:
  port: 8080
mybatis-plus:
  configuration:
    # é…ç½®æ—¥å¿—ä¿¡æ¯
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
    # å…³é—­é©¼å³°æ˜ å°„
    map-underscore-to-camel-case: false

```



## ç”¨æˆ·æ•°æ®åº“è¡¨è®¾è®¡

| å­—æ®µ         | å±æ€§     | å¤‡æ³¨                        |
| ------------ | -------- | --------------------------- |
| id           | bigint   | ä¸»é”®                        |
| userName     | varchar  | ç”¨æˆ·å                      |
| userAccount  | varchar  | ç”¨æˆ·è´¦å·                    |
| gender       | tinyint  | æ€§åˆ«                        |
| userPassword | varchar  | å¯†ç                         |
| phone        | varchar  | ç”µè¯                        |
| email        | varchar  | é‚®ç®±                        |
| userStatus   | tinyint  | çŠ¶æ€ï¼ˆ1 æœ‰æ•ˆ 0 ç¦ç”¨ï¼‰       |
| avatarUrl    | varchar  | å¤´åƒ                        |
| createTime   | datetime | åˆ›å»ºæ—¶é—´                    |
| updateTime   | datetime | æ›´æ–°æ—¶é—´                    |
| isDelete     | tinyint  | æ˜¯å¦åˆ é™¤ï¼ˆ1 æœªåˆ é™¤ 0 åˆ é™¤ï¼‰ |

> æœ€åä¸‰ä¸ªå­—æ®µå±äºé€šç”¨å­—æ®µï¼Œé€‚ç”¨äºä»»ä½•ä¸€å¼ è¡¨
>
> è¿™é‡ŒuserNameå’ŒuserPasswordå’ŒuserStatusä¹‹æ‰€ä»¥è¿™æ ·å‘½åï¼Œæ˜¯é¿å…å’ŒMySQLçš„å…³é”®è¯é‡å¤

```sql
create table user
(
    id bigint auto_increment comment 'ä¸»é”®',
    userName varchar(255) not null comment 'ç”¨æˆ·å',
    userPassword varchar(255) not null,
    userAccount varchar(255) null comment 'ç”¨æˆ·è´¦å·',
    gender tinyint default 1 not null comment 'æ€§åˆ« 1-ç”· 0-å¥³',
    phone varchar(255) null comment 'ç”µè¯',
    email varchar(255) null comment 'é‚®ç®±',
    userStatus tinyint default 1 null comment 'çŠ¶æ€ 1-å¯ç”¨ 0-ç¦ç”¨',
    avatarUrl varchar(1024) null comment 'å¤´åƒ',
    updateTime datetime default CURRENT_TIMESTAMP not null,
    createTime datetime default CURRENT_TIMESTAMP on update CURRENT_TIMESTAMP not null,
    isDelete tinyint default 1 not null comment 'é€»è¾‘åˆ é™¤ 1-æœªåˆ é™¤ 0-åˆ é™¤',
    constraint user_pk
        primary key (id)
)
    comment 'ç”¨æˆ·è¡¨';
```

## ä¸€ä¸ªåŸºæœ¬çš„é¡¹ç›®ç›®å½•

![image-20230424201551843-1682338555067-1](http://pic.user-center.xyz/images/2023/05/06/image-20230424201551843-1682338555067-1.png)

## ä½¿ç”¨MyBatisXæ’ä»¶è‡ªåŠ¨ç”Ÿæˆç›¸å…³æ–‡ä»¶

![image-20230424201651384](http://pic.user-center.xyz/images/2023/05/06/image-20230424201651384.png)

![image-20230424201708767](http://pic.user-center.xyz/images/2023/05/06/image-20230424201708767.png)

> ä½¿ç”¨MyBatisXæ’ä»¶å¯ä»¥å¿«é€Ÿç”Ÿæˆå¯¹åº”çš„modelã€serviceã€mapperæ–‡ä»¶ï¼Œæé«˜å¼€å‘æ•ˆç‡
>
> æ¥ä¸‹æ¥æµ‹è¯•ç”Ÿæˆçš„æ–‡ä»¶æ˜¯å¦å¯ç”¨

```java
@SpringBootTest
public class UserServiceTest {
    @Resource
    private UserService userService;
    @Test
    public void testAddUser(){
        User user = new User();
        user.setUserName("object");
        user.setUserPassword("object");
        user.setUserAccount("object");

        boolean save = userService.save(user);
        assertTrue(save);
    }
}
```

## ä¸šåŠ¡é€»è¾‘ç¼–å†™

### æ³¨å†Œé€»è¾‘

1. ç”¨æˆ·åœ¨å‰ç«¯è¾“å…¥è´¦æˆ·ã€å¯†ç ã€ç¡®è®¤å¯†ç ã€æ ¡éªŒç ï¼ˆcodeï¼‰
2. æ ¡éªŒè´¦æˆ·ã€å¯†ç æ˜¯å¦ç¬¦åˆè¦æ±‚
   1. è´¦æˆ·ä¸èƒ½å°äº6ä½
   2. å¯†ç ä¸èƒ½å°äº6ä½ï¼Œä¸èƒ½æœ‰ç‰¹æ®Šå­—ç¬¦
   3. å¯†ç å’Œç¡®è®¤å¯†ç æ˜¯å¦ä¸€è‡´
   4. è´¦æˆ·ä¸èƒ½é‡å¤
   5. è´¦æˆ·ä¸å«ç‰¹æ®Šå­—ç¬¦
3. å¯¹å¯†ç è¿›è¡ŒåŠ å¯†å­˜å‚¨ï¼ˆ**å¯†ç ä¸èƒ½æ˜æ–‡å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œå¦‚æœæ•°æ®åº“æ³„éœ²ç­‰äº‹ä»¶å‘ç”Ÿï¼Œä¼šå¾ˆå±é™©**ï¼‰
4. å‘æ•°æ®åº“ä¸­æ’å…¥æ•°æ®

> ç¼–å†™è¯·æ±‚ä½“ï¼Œå°è£…è¯·æ±‚æ•°æ®

```java
/**
 * æ³¨å†Œè¯·æ±‚ä½“
 * @author ObjectY
 */
@Data
public class RegisterRequest {
    String userAccount;
    String userPassword;
    String checkPassword;
}
```

> å¯¼å…¥commons-lang3å·¥å…·åŒ…ï¼Œè¾…åŠ©æˆ‘ä»¬åšè´¦æˆ·çš„æ ¡éªŒ

```xml
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-lang3</artifactId>
        </dependency>
```

```java
/**
* @author ObjectY
* @description é’ˆå¯¹è¡¨ã€user(ç”¨æˆ·è¡¨)ã€‘çš„æ•°æ®åº“æ“ä½œServiceå®ç°
* @createDate 2023-04-24 20:16:55
*/
@Service
public class UserServiceImpl extends ServiceImpl<UserMapper, User>
    implements UserService{

    private static final String PASSWORD_REGEX = "^[a-zA-Z0-9]{6,10}$";

    private static final String SALT = "Object";

    @Override
    public Long userRegister(RegisterRequest registerRequest) {
        String userAccount = registerRequest.getUserAccount();
        String userPassword = registerRequest.getUserPassword();
        String checkPassword = registerRequest.getCheckPassword();
        //éç©ºåˆ¤æ–­
        if(StringUtils.isAnyBlank(userAccount,userPassword,checkPassword)){
            return -1L;
        }
        //è´¦å·å’Œå¯†ç ä¸èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦(åªèƒ½ä½¿ç”¨å¤§å°å†™å­—æ¯å’Œæ•°å­—)
        Pattern pattern = Pattern.compile(PASSWORD_REGEX);
        Matcher matcher = pattern.matcher(userPassword);
        Matcher matcher2 = pattern.matcher(userAccount);
        if(!matcher.matches() || !matcher2.matches()){
            return -1L;
        }
        //è´¦æˆ·ä¸èƒ½é‡å¤
        LambdaQueryWrapper<User> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(User::getUserAccount, userAccount);
        User user = this.getOne(wrapper);
        if(!Objects.isNull(user)){
            return -1L;
        }

        //ç»™å¯†ç è¿›è¡ŒåŠ å¯†
        String newPassword = DigestUtils.md5DigestAsHex((SALT + userPassword).getBytes(StandardCharsets.UTF_8));

        //å­˜å‚¨ç”¨æˆ·
        User currentUser = new User();
        currentUser.setUserName(userAccount);
        currentUser.setUserAccount(userAccount);
        currentUser.setUserPassword(newPassword);
        boolean save = this.save(currentUser);
        if(!save){
            return -1L;
        }
        return 1L;
    }
}
```

> ä¸‹é¢æ˜¯å¯¹æ­¤ä»£ç çš„æµ‹è¯•

```java
    @Test
    public void testRegister(){
        //å¯†ç ä¸ºç©º
        RegisterRequest registerRequest = new RegisterRequest();
        registerRequest.setUserAccount("object");
        registerRequest.setUserPassword("");
        registerRequest.setCheckPassword("1234567");
        assertEquals(-1L, userService.userRegister(registerRequest));
        //è´¦æˆ·é•¿åº¦å°äº4ä½
        registerRequest.setUserAccount("obj");
        registerRequest.setUserPassword("");
        registerRequest.setCheckPassword("1234567");
        assertEquals(-1L, userService.userRegister(registerRequest));
        //å¯†ç é•¿åº¦å°äº6ä½
        registerRequest.setUserAccount("object");
        registerRequest.setUserPassword("12345");
        registerRequest.setCheckPassword("12345");
        assertEquals(-1L, userService.userRegister(registerRequest));
        //ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´
        registerRequest.setUserAccount("object");
        registerRequest.setUserPassword("12345678");
        registerRequest.setCheckPassword("1234567");
        assertEquals(-1L, userService.userRegister(registerRequest));
        //è´¦æˆ·åä¸èƒ½é‡å¤
        registerRequest.setUserAccount("object");
        registerRequest.setUserPassword("1234567");
        registerRequest.setCheckPassword("1234567");
        assertEquals(-1L, userService.userRegister(registerRequest));
        //å¯†ç åŒ…å«ç‰¹æ®Šå­—ç¬¦
        registerRequest.setUserAccount("object");
        registerRequest.setUserPassword("1234567(");
        registerRequest.setCheckPassword("1234567(");
        assertEquals(-1L, userService.userRegister(registerRequest));
        //è´¦æˆ·åŒ…å«ç‰¹æ®Šå­—ç¬¦
        registerRequest.setUserAccount("object**");
        registerRequest.setUserPassword("1234567");
        registerRequest.setCheckPassword("1234567");
        assertEquals(-1L, userService.userRegister(registerRequest));
        //æ³¨å†ŒæˆåŠŸ
        registerRequest.setUserAccount("object123");
        registerRequest.setUserPassword("1234567");
        registerRequest.setCheckPassword("1234567");
        assertEquals(1L, userService.userRegister(registerRequest));
    }
```

### ç™»å½•é€»è¾‘ç¼–å†™ï¼ˆç›®å‰æ˜¯å•æœºç™»å½• åç»­æ”¹æˆåˆ†å¸ƒå¼ç™»å½•ï¼‰

1. ç”¨æˆ·åœ¨å‰ç«¯è¾“å…¥è´¦å·å’Œå¯†ç 
2. åç«¯å¯¹è´¦å·å’Œå¯†ç è¿›è¡Œæ ¡éªŒ
3. æ ¹æ®è´¦å·æŸ¥è¯¢å‡ºç”¨æˆ·ä¿¡æ¯
4. å¯¹ç”¨æˆ·ä¿¡æ¯è¿›è¡Œè„±æ•
5. å­˜å‚¨ç”¨æˆ·çš„ç™»å½•æ€ï¼ˆsessionï¼‰
6. è¿”å›è„±æ•åçš„ç”¨æˆ·ä¿¡æ¯

> è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬å­˜åœ¨ä¸€ä¸ªé€»è¾‘åˆ é™¤å­—æ®µï¼Œæ‰€ä»¥éœ€è¦å¦‚æœåˆ é™¤çš„ç”¨æˆ·æ˜¯ä¸éœ€è¦å»æŸ¥è¯¢å‡ºæ¥çš„ï¼Œå¹¶ä¸”ä½¿ç”¨äº†sessionå»è®°å½•ç™»å½•æ€ï¼Œæ‰€ä»¥è¦é…ç½®ä¸€ä¸‹sessionçš„è¿‡æœŸæ—¶é—´

```yaml
      # é…ç½®é€»è¾‘åˆ é™¤
      logic-delete-value: 0
      logic-not-delete-value: 1
      
       session:
    	timeout: 86400
```

```java
    /**
     * é€»è¾‘åˆ é™¤ 1-æœªåˆ é™¤ 0-åˆ é™¤
     */
    @TableLogic
    private Integer isDelete;
```

> æ¥ä¸‹æ¥æ˜¯ä»£ç ç¼–å†™

```java
    @Override
    public User userLogin(LoginRequest loginRequest, HttpServletRequest request) {
        String userAccount = loginRequest.getUserAccount();
        String userPassword = loginRequest.getUserPassword();

        // åŸºæœ¬çš„æ ¡éªŒ
        if(StringUtils.isAnyBlank(userAccount,userPassword)){
            return null;
        }
        Pattern pattern = Pattern.compile(PASSWORD_REGEX);
        Matcher matcher = pattern.matcher(userPassword);
        Matcher matcher2 = pattern.matcher(userAccount);
        if(!matcher.matches() || !matcher2.matches()){
            return null;
        }
        // æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
        LambdaQueryWrapper<User> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(User::getUserAccount, userAccount);
        User user = this.getOne(wrapper);
        if(Objects.isNull(user)){
            return null;
        }
        //åˆ¤æ–­å¯†ç æ˜¯å¦ç›¸ç­‰
        if(!DigestUtils.md5DigestAsHex((SALT + userPassword).getBytes(StandardCharsets.UTF_8)).equals(user.getUserPassword())){
            return null;
        }
        //ç”¨æˆ·ä¿¡æ¯è„±æ•
        User safetyUser = getSafetyUser(user);

        //å­˜å‚¨ç”¨æˆ·ç™»å½•æ€
        request.getSession().setAttribute(USER_LOGIN_STATE, safetyUser);

        return safetyUser;
    }

    /**
     * ç”¨æˆ·ä¿¡æ¯è„±æ•æ–¹æ³•
     * @param user åŸç”¨æˆ·
     * @return å®‰å…¨ç”¨æˆ·
     */
    private User getSafetyUser(User user) {
        User safetyUser = new User();
        safetyUser.setId(user.getId());
        safetyUser.setUserName(user.getUserName());
        safetyUser.setUserPassword(null);
        safetyUser.setUserAccount(user.getUserAccount());
        safetyUser.setGender(user.getGender());
        safetyUser.setPhone(user.getPhone());
        safetyUser.setEmail(user.getEmail());
        safetyUser.setUserStatus(user.getUserStatus());
        safetyUser.setAvatarUrl(user.getAvatarUrl());
        safetyUser.setUpdateTime(user.getCreateTime());

        return safetyUser;
    }
```

## Controllerå±‚ç¼–å†™

```java
/**
 * ç”¨æˆ·æ¥å£å±‚
 * @author ObjectY
 */
@RestController
@RequestMapping("/user")
public class UserController {
    @Resource
    private UserService userService;

    @PostMapping("/register")
    public Long register(@RequestBody RegisterRequest registerRequest){
        //è¿™é‡Œé‡æ–°è¿›è¡Œæ ¡éªŒæ˜¯ä¿è¯serviceçš„å¯å¤ç”¨æ€§ï¼Œserviceæ–¹æ³•ä¸æ­¢ä¸€ä¸ªcontrollerä¼šè¿›è¡Œè°ƒç”¨
        if(Objects.isNull(registerRequest)){
            return -1L;
        }
        String userAccount = registerRequest.getUserAccount();
        String userPassword = registerRequest.getUserPassword();
        String checkPassword = registerRequest.getCheckPassword();
        if(StringUtils.isAnyBlank(userAccount, userPassword,checkPassword)){
            return -1L;
        }

        return userService.userRegister(registerRequest);
    }
    
    @PostMapping("/login")
    public User login(@RequestBody LoginRequest loginRequest, HttpServletRequest request){

        if(Objects.isNull(loginRequest)){
            return null;
        }
        String userAccount = loginRequest.getUserAccount();
        String userPassword = loginRequest.getUserPassword();
        if(StringUtils.isAnyBlank(userAccount, userPassword)){
            return null;
        }

        return userService.userLogin(loginRequest, request);
    }
}

    @PostMapping("/login")
    public User login(@RequestBody LoginRequest loginRequest, HttpServletRequest request){

        if(Objects.isNull(loginRequest)){
            return null;
        }
        String userAccount = loginRequest.getUserAccount();
        String userPassword = loginRequest.getUserPassword();
        if(StringUtils.isAnyBlank(userAccount, userPassword)){
            return null;
        }

        return userService.userLogin(loginRequest, request);
    }

    /**
     * æŸ¥è¯¢ç”¨æˆ·
     * @param userName ç”¨æˆ·å
     * @return ç”¨æˆ·åˆ—è¡¨
     */
    @GetMapping("/search")
    public List<User> searchUsers(String userName){
        LambdaQueryWrapper<User> wrapper = new LambdaQueryWrapper<>();
        wrapper.like(User::getUserName, userName);
        
        return userService.list(wrapper);
    }
```

## æµ‹è¯•æ¥å£

> ideaä¸­è‡ªå¸¦æ¥å£æµ‹è¯•çš„å·¥å…·ï¼Œå¯ä»¥å³é”® -> æ–°å»ºHTTPè¯·æ±‚æ–‡ä»¶

```http
POST http://localhost:8080/user/login
Content-Type: application/json
{
  "userAccount": "object123",
  "userPassword": "1234567"
}

```

```http
POST http://localhost:8080/user/register
Content-Type: application/json
{
  "userAccount": "object1234",
  "userPassword": "1234567",
  "checkPassword": "1234567"
}
```

## è¡¥å……å­—æ®µ

> è¡¥å……ä¸€ä¸ªuserRoleå­—æ®µï¼Œç”¨æ¥åšç”¨æˆ·èº«ä»½æ ¡éªŒï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ˜¯ç®¡ç†å‘˜

```java
    private Integer userRole;
```

> æ¥ä¸‹æ¥ä¿®æ”¹ç”¨æˆ·è„±æ•æ–¹æ³•ï¼Œè¿”å›ç”¨æˆ·è§’è‰²ä¿¡æ¯

```java
    /**
     * ç”¨æˆ·ä¿¡æ¯è„±æ•æ–¹æ³•
     * @param user åŸç”¨æˆ·
     * @return å®‰å…¨ç”¨æˆ·
     */
    private User getSafetyUser(User user) {
        User safetyUser = new User();
        safetyUser.setId(user.getId());
        safetyUser.setUserName(user.getUserName());
        safetyUser.setUserPassword(null);
        safetyUser.setUserAccount(user.getUserAccount());
        safetyUser.setGender(user.getGender());
        safetyUser.setPhone(user.getPhone());
        safetyUser.setEmail(user.getEmail());
        safetyUser.setUserStatus(user.getUserStatus());
        safetyUser.setAvatarUrl(user.getAvatarUrl());
        safetyUser.setUpdateTime(user.getCreateTime());
        safetyUser.setUserRole(user.getUserRole());

        return safetyUser;
    }
```

## ç¼–å†™ç®¡ç†å‘˜å¯è®¿é—®æ¥å£

> è¡¥å……å¸¸é‡ç±»ï¼Œå­˜æ”¾ç”¨åˆ°çš„æ‰€ç”¨å¸¸é‡

```java
/**
 * ç”¨æˆ·å¸¸é‡ç±»
 * @author ObjectY
 */
public interface UserConstant {

    String PASSWORD_REGEX = "^[a-zA-Z0-9]{6,10}$";

    String SALT = "Object";

    String USER_LOGIN_STATE = "userLoginState";
}
```

> ç¼–å†™é€šç”¨æ–¹æ³•ï¼Œåˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯ç®¡ç†å‘˜

```java
/**
 * é€šç”¨æ–¹æ³•ç±»
 * @author ObjectY
 */
public class CommonUtils {
    
    public static boolean checkAdmin(HttpServletRequest request){
        //è·å–ç™»å½•ç”¨æˆ·ä¿¡æ¯
        User loginUser = (User) request.getSession(false).getAttribute(USER_LOGIN_STATE);
        //åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®æ­¤æ¥å£
        if(Objects.isNull(loginUser)){
            return false;
        }
        if(!loginUser.getUserRole().equals(ADMIN_ROLE)){
            return false;
        }
        return true;
    }
}
```

> æœ€åç¼–å†™æ¥å£å³å¯

```java
    /**
     * æŸ¥è¯¢ç”¨æˆ·
     * @param userName ç”¨æˆ·å
     * @param request request
     * @return ç”¨æˆ·åˆ—è¡¨
     */
    @GetMapping("/search")
    public List<User> searchUsers(String userName,HttpServletRequest request){
        if(!CommonUtils.checkAdmin(request)){
            return new ArrayList<>();
        }
        LambdaQueryWrapper<User> wrapper = new LambdaQueryWrapper<>();
        wrapper.like(User::getUserName, userName);

        return userService.list(wrapper).stream().map(user -> userService.getSafetyUser(user)).collect(Collectors.toList());
    }

    /**
     * åˆ é™¤ç”¨æˆ·
     * @param id ç”¨æˆ·id
     * @param request request
     * @return bool
     */
    @PostMapping("/delete")
    public Boolean delete(@RequestBody Long id,HttpServletRequest request){
        if(!CommonUtils.checkAdmin(request)){
            return false;
        }
        if(id <= 0){
            return false;
        }

        return userService.removeById(id);
    }
```

> è‡³æ­¤ï¼Œå®Œæˆç”¨æˆ·çš„å¢åˆ æ”¹æŸ¥æ–¹æ³•



****



## åç«¯ä¼˜åŒ–éƒ¨åˆ†

> è¡¥å……è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯æ¥å£

```java
    @GetMapping("/currentUser")
    public User getCurrentUser(HttpServletRequest request){
        User loginUser = (User) request.getSession().getAttribute(USER_LOGIN_STATE);
        if(Objects.isNull(loginUser)){
            return null;
        }
        Long userId = loginUser.getId();
        User user = userService.getById(userId);
        User currentUser = userService.getSafetyUser(user);

        return currentUser;
    }
```

> è¿™é‡Œä¸ºäº†é˜²æ­¢ç”¨æˆ·ä¿¡æ¯æ›´æ–°åï¼Œsessionä¸­çš„ä¿¡æ¯å¹¶æ²¡æœ‰æ›´æ–°ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œé€‰æ‹©æŸ¥åº“è¿”å›å½“å‰ç”¨æˆ·ä¿¡æ¯
>
> å½“ç„¶å…·ä½“æƒ…å†µå…·ä½“åˆ†æï¼Œå¦‚æœå¯¹äºç”¨æˆ·ä¿¡æ¯æ›´æ–°å¹¶ä¸é¢‘ç¹çš„ç³»ç»Ÿæ¥è¯´ï¼Œå½“æ›´æ–°æ•°æ®åº“çš„æ—¶å€™æ›´æ–°ä¸€ä¸‹sessionï¼Œç„¶åä»sessionä¸­å»ä¿¡æ¯å³å¯

### è¡¥å……é‚€è¯·ç æœºåˆ¶

> ç”¨æˆ·æ³¨å†Œçš„æ—¶å€™éœ€è¦å¡«å†™é‚€è¯·ç ï¼Œå¯¹ç”¨æˆ·è¿›è¡Œæ ¡éªŒ

1. ç»™ç”¨æˆ·è¡¥å……ä¸€ä¸ªé‚€è¯·ç å­—æ®µ
2. ç”¨æˆ·åœ¨å‰ç«¯å¡«å†™é‚€è¯·ç 
3. åç«¯æ ¡éªŒæ­¤é‚€è¯·ç æ˜¯å¦å­˜åœ¨
4. å½“ç”¨æˆ·æ³¨å†Œçš„æ—¶å€™è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªéšæœºçš„é‚€è¯·ç 

```java
        //åˆ¤æ–­å½“å‰é‚€è¯·ç æ˜¯å¦å­˜åœ¨
        LambdaQueryWrapper<User> queryWrapper = new LambdaQueryWrapper<>();
        queryWrapper.eq(User::getInvitationCode, invitationCode);
        User invitationUser = this.getOne(queryWrapper);
        if(Objects.isNull(invitationUser)){
            return -1L;
        }

		//éšæœºç”Ÿæˆé‚€è¯·ç å¹¶åˆ¤æ–­æ˜¯å¦å­˜åœ¨
        String userInvitationCode = RandomInvitationCode.generateCode();
        queryWrapper.clear();
        queryWrapper.eq(User::getInvitationCode, userInvitationCode);
        User one = this.getOne(queryWrapper);
        while(one != null){
            userInvitationCode = RandomInvitationCode.generateCode();
            queryWrapper.clear();
            queryWrapper.eq(User::getInvitationCode, userInvitationCode);
            one = this.getOne(queryWrapper);
        }

		currentUser.setInvitationCode(userInvitationCode);
```

### å°è£…é€šç”¨è¿”å›å¯¹è±¡

> ç›®çš„ï¼šè§„èŒƒè¿”å›ç»™å‰ç«¯çš„ä¿¡æ¯ï¼Œè®©å‰ç«¯å¯ä»¥æ›´å¥½çš„å°†å¤„ç†ç»“æœå±•ç°ç»™ç”¨æˆ·æˆ–è€…å±•ç°åˆ°ç•Œé¢ä¸Šï¼ŒåŒæ—¶ä¹Ÿæ–¹ä¾¿åç«¯äººå‘˜è°ƒè¯•æ‰¾åˆ°é”™è¯¯

```java
/**
 * é€šç”¨è¿”å›ä½“
 * @author ObjectY
 */
@Data
public class BaseResponse<T> implements Serializable {
    private static final long serialVersionUID = 947757056421018877L;

    private Integer code;

    private String message;

    private T data;

    private String description;

    public BaseResponse(int code ,T data, String message,String description){
        this.code = code;
        this.data = data;
        this.message = message;
        this.description = description;
    }

    public BaseResponse(int code,T data ,String message){
        this(code,data,message,"");
    }

    public BaseResponse(int code ,String message){
        this(code,null,message);
    }

    public BaseResponse(ErrorCode errorCode){
        this(errorCode.getCode(),null,errorCode.getMessage(),errorCode.getDescription());
    }
}
```

```java
/**
 * å°è£…é€šç”¨è¿”å›ç±»
 * @author ObjectY
 */
public class ResultUtils {
    public static <T> BaseResponse<T> success(T data){
        return new BaseResponse<>(ErrorCode.SUCCESS.getCode(),data,"success");
    }

    public static <T> BaseResponse<T> error(ErrorCode errorCode){
        return new BaseResponse<>(errorCode.getCode(),null,errorCode.getMessage(),errorCode.getDescription());
    }
}
```

```java
/**
 * è‡ªå®šä¹‰é”™è¯¯ç ï¼Œå°è£…é”™è¯¯ä¿¡æ¯
 * @author ObjectY
 */
public enum ErrorCode {
    PARAMS_ERROR(40000,"å‚æ•°é”™è¯¯",""),
    NOT_LOGIN(40001,"æœªç™»å½•",""),
    NO_AUTH(40100,"æ— æƒé™",""),
    SYSTEM_ERROR(50000,"ç³»ç»Ÿé”™è¯¯",""),
    SUCCESS(200,"success","")
    ;
    private final int code;
    private final String message;
    private final String description;

    ErrorCode(int code, String message, String description) {
        this.code = code;
        this.message = message;
        this.description = description;
    }
}
```

### å°è£…å…¨å±€å¼‚å¸¸å¤„ç†

> ç›®çš„ï¼šç¼–å†™è‡ªå®šä¹‰å…¨å±€å¼‚å¸¸ï¼Œå°è£…ç¨‹åºä¸­çš„å¼‚å¸¸ä¿¡æ¯ï¼Œå°†å…¶ç»Ÿä¸€å¤„ç†ï¼Œç„¶åç¼–å†™å…¨å±€å¼‚å¸¸æ•è·ï¼Œæ•è·ç¨‹åºä¸­çš„è‡ªå®šä¹‰å¼‚å¸¸ï¼Œå°†è‡ªå®šä¹‰å¼‚å¸¸é›†ä¸­åœ¨ä¸€èµ·è¿›è¡Œè¿”å›

```java
/**
 * è‡ªå®šä¹‰å¼‚å¸¸
 * @author ObjectY
 */
public class BusinessException extends RuntimeException{

    private int code;
    private String description;

    public BusinessException(String message,int code,String description) {
        super(message);
        this.code = code;
        this.description = description;
    }

    public BusinessException(ErrorCode errorCode){
        super(errorCode.getMessage());
        this.code = errorCode.getCode();
        this.description = errorCode.getDescription();
    }

    public int getCode() {
        return code;
    }

    public String getDescription() {
        return description;
    }
}

/**
 * å…¨å±€å¼‚å¸¸æ•è·
 * @author ObjectY
 */
@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(BusinessException.class)
    public BaseResponse businessExceptionHandler(BusinessException ex){
        return ResultUtils.error(ex.getCode(),ex.getMessage(),ex.getDescription());
    }
}
```



## é¡¹ç›®éƒ¨ç½²

### å¤šç¯å¢ƒ

> ä»€ä¹ˆæ˜¯å¤šç¯å¢ƒï¼Ÿ
>
> [(22æ¡æ¶ˆæ¯) å¤šç¯å¢ƒè®¾è®¡_ç¨‹åºå‘˜é±¼çš®çš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/weixin_41701290/article/details/120173283)

> ä¸ºä»€ä¹ˆéœ€è¦å¤šç¯å¢ƒï¼Ÿ
>
> 1. æ¯ä¸ªç¯å¢ƒä¸­çš„ä»£ç äº’ä¸å½±å“ï¼ˆä¾‹å¦‚éœ€è¦æ”¹åŠ¨ä»£ç ï¼Œä¸éœ€è¦åŠ¨ä¸Šçº¿ç¯å¢ƒï¼Œåªéœ€è¦ä¿®æ”¹æµ‹è¯•ç¯å¢ƒï¼Œçº¿ä¸Šç¯å¢ƒå¹¶ä¸ä¼šå—åˆ°å½±å“ï¼‰
> 2. åŒºåˆ†ä¸åŒçš„é˜¶æ®µ å¼€å‘ ã€æµ‹è¯•  ã€ç”Ÿäº§
> 3. å¯¹é¡¹ç›®è¿›è¡Œä¼˜åŒ–
>    1. æœ¬åœ°æ—¥å¿—çº§åˆ«
>    2. ç²¾ç®€ä¾èµ–ï¼ŒèŠ‚çœé¡¹ç›®ä½“ç§¯
>    3. åŠ¨æ€è°ƒæ•´é¡¹ç›®çš„ç¯å¢ƒ / å‚æ•° ï¼ˆJVMå‚æ•°è°ƒæ•´ï¼‰

å¤šç¯å¢ƒåˆ†ç±»ï¼š

1. æœ¬åœ°ç¯å¢ƒ ï¼ˆä¸ªäººç”µè„‘ï¼‰
2. å¼€å‘ç¯å¢ƒ ï¼ˆä¾‹å¦‚ ä¸€äº›å¤§å‹å…¬å¸çš„å†…ç½‘æœåŠ¡å™¨ï¼Œç±»ä¼¼è¿œç¨‹å¼€å‘ï¼‰
3. æµ‹è¯•ç¯å¢ƒ ï¼ˆæµ‹è¯•ï¼‰ å¼€å‘ / æµ‹è¯• / äº§å“ï¼Œä¸€èˆ¬ä¸ºç‹¬ç«‹çš„æ•°æ®åº“ï¼Œç‹¬ç«‹çš„æœåŠ¡å™¨
4. é¢„å‘å¸ƒç¯å¢ƒ ï¼ˆä½“éªŒæœï¼‰ ä¸æ­£å¼ç¯å¢ƒä¸€ç›´
5. æ­£å¼ç¯å¢ƒ ï¼ˆæ­£å¼æœï¼‰
6. æ²™ç®±ç¯å¢ƒ ï¼ˆå®éªŒç¯å¢ƒï¼‰ æµ‹è¯•æ–°åŠŸèƒ½



### å‰ç«¯å¤šç¯å¢ƒ

* è¯·æ±‚åœ°å€
  * å¼€å‘ç¯å¢ƒï¼šlocalhost:8000
  * çº¿ä¸Šç¯å¢ƒï¼šbackend.user-center.top

```tsx
const request = extend({
  credentials: 'include',
  prefix: process.env.NODE_ENV === 'production' ? 'http://backend.user-center.top' : undefined
})
```

### åç«¯å¤šç¯å¢ƒ

```yaml
spring:
  application:
    name: usercenter-backend
  # é…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://xxxxx:3306/user_center_backend
    username: xxx
    password: xxxxx
  session:
    timeout: PT15M
server:
  port: 8080
  servlet:
    context-path: /api
mybatis-plus:
  configuration:
    # é…ç½®æ—¥å¿—ä¿¡æ¯
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
    # å…³é—­é©¼å³°æ˜ å°„
    map-underscore-to-camel-case: false
  # é…ç½®idç­–ç•¥
  global-config:
    db-config:
      id-type: auto
      # é…ç½®é€»è¾‘åˆ é™¤
      logic-delete-value: 0
      logic-not-delete-value: 1


```

> ä¸»è¦æ˜¯æ›´æ”¹æ•°æ®åº“/redis/æ¶ˆæ¯é˜Ÿåˆ—ç­‰å·¥å…·çš„é“¾æ¥åœ°å€ä»¥åŠä¸€äº›é…ç½®

![image-20230501221214235](http://pic.user-center.xyz/images/2023/05/06/image-20230501221214235.png)

> ç„¶åä½¿ç”¨mavenè¿›è¡Œæ‰“åŒ…ï¼Œæ‰“åŒ…å®Œæˆåä½¿ç”¨ä¸‹åˆ—å‘½ä»¤å¯åŠ¨é¡¹ç›®

```cmd
java -jar xxxx.jar --spring.profiles.active=prod
```

### åŸç”Ÿéƒ¨ç½²

å‰ç«¯ï¼š

1. å®‰è£…nginxæœåŠ¡å™¨

è¿™é‡Œä½¿ç”¨æœ€åŸå§‹çš„æ–¹å¼ï¼Œåˆ°å®˜ç½‘è¿›è¡Œå®‰è£…

2. éƒ¨ç½²nginxæœåŠ¡å™¨ [CentOSå¦‚ä½•å®‰è£…nginx - çŸ¥ä¹ (zhihu.com)](https://zhuanlan.zhihu.com/p/136824395) ï¼ˆè¿™é‡Œå¯ä»¥é…ç½®æˆç¯å¢ƒå˜é‡æ–¹ä¾¿åç»­å¯åŠ¨ï¼‰
3. å°†å‰ç«¯é¡¹ç›®æ‰“åŒ…ç„¶åä¸Šä¼ åˆ°æœåŠ¡å™¨
4. é…ç½®nginx.confæŒ‡å‘å‰ç«¯æ‰“åŒ…çš„é¡¹ç›®



åç«¯ï¼š

1. åœ¨æœåŠ¡å™¨ä¸Šå®‰è£…jdk1.8å’Œmaven
2. è¿™é‡Œæœ‰ä¸¤ä¸ªé€‰æ‹©
   1. ä»gitä¸Šæ‹‰å–ä»£ç ï¼Œç„¶ååœ¨æœåŠ¡ç«¯è¿›è¡Œæ‰“åŒ…
   2. åœ¨æœ¬åœ°æ‰“åŒ…ï¼Œç„¶åç›´æ¥ä¸Šä¼ åˆ°æœåŠ¡å™¨ ï¼ˆè¿™é‡Œè€ƒè™‘åˆ°æœåŠ¡å™¨ç¬¬ä¸€æ¬¡å®‰è£…mavenï¼Œæ‰“åŒ…ä¼šæ¯”è¾ƒæ…¢ï¼Œæ‰€ä»¥é€‰æ‹©æœ¬åœ°æ‰“åŒ…ç„¶åä¸Šä¼ ï¼‰
3. ä½¿ç”¨nohupå‘½ä»¤ï¼ŒæŒ‚èµ·è¿è¡Œåç«¯jaråŒ…



è‡³æ­¤ï¼ŒåŸç”Ÿéƒ¨ç½²æ–¹å¼å®Œæ¯•ï¼

### å®å¡”éƒ¨ç½² ï¼ˆæœ€ç®€å•ï¼‰

1. å®‰è£…å®å¡”é¢æ¿ [å®å¡”é¢æ¿ä¸‹è½½ï¼Œå…è´¹å…¨èƒ½çš„æœåŠ¡å™¨è¿ç»´è½¯ä»¶ (bt.cn)](https://www.bt.cn/new/download.html)

2. è¿›å…¥å®å¡”é¢æ¿ï¼Œåœ¨è½¯ä»¶å•†åº—ä¸­å®‰è£…nginxï¼Œtomcat(ä¸ºäº†å®‰è£…java)ï¼Œdockerï¼Œmysql
3. å°†å‰ç«¯é¡¹ç›®æ‰“åŒ…ä¸Šä¼ 
4. å°†åç«¯é¡¹ç›®æ‰“åŒ…ä¸Šä¼ 
5. ä¸€é”®éƒ¨ç½²å‰ç«¯
6. ä¸€é”®éƒ¨ç½²åç«¯



### dockeréƒ¨ç½²ï¼š

dockeræ˜¯å®¹å™¨ï¼Œå°†é¡¹ç›®çš„ç¯å¢ƒå’Œä»£ç æ‰“åŒ…æˆä¸€ä¸ªé•œåƒï¼Œé•œåƒæ›´å®¹æ˜“åˆ†å‘å’Œç§»æ¤

å†æ¬¡å¯åŠ¨é¡¹ç›®å¯ç›´æ¥è¿è¡Œé•œåƒ

1. å®å¡”å®‰è£…docker
2. ideaä¸‹è½½dockeræ’ä»¶ï¼Œç¼–å†™Dockerfileæ–‡ä»¶

```dockerfile
FROM maven:3.5-jdk-8-alpine as builder

# æŒ‡å®šå·¥ä½œç›®å½•
WORKDIR /app
# å°†pomæ–‡ä»¶å¤åˆ¶åˆ°å·¥ä½œç›®å½•
COPY pom.xml .
# å°†srcç›®å½•å¤åˆ¶åˆ°å·¥ä½œç›®å½•
COPY src ./src
# æŒ‡å®šæ‰“åŒ…å‘½ä»¤
RUN mvn package -DskipTests

CMD ["java","-jar","app/target/backend-0.0.1-SNAPSHOT.jar","--spring.profiles.active=prod"]
```



docker run è¿è¡Œé•œåƒ



### Dockerå¹³å°éƒ¨ç½²

1. è…¾è®¯äº‘
2. åç«¯å¾®ä¿¡äº‘æ‰˜ç®¡
3. å‰ç«¯webify



## é¡¹ç›®ä¸Šçº¿

1. åŸŸåè§£æ ï¼ˆå»äº‘å¹³å°è¿›è¡Œè§£æï¼‰
1. åœ¨å®å¡”ä¸­ç½‘ç«™éƒ¨ç½²åœ°æ–¹ç»‘å®šè§£æåçš„åŸŸå
1. ä¿®æ”¹å‰ç«¯é¡¹ç›®ï¼Œè¯·æ±‚åç«¯çš„åŸŸå



æ¥ä¸‹æ¥çš„äº‹æƒ…å¾ˆé‡è¦ï¼Œåœ¨å®å¡”ä¸­éƒ¨ç½²ä¸¤ä¸ªç½‘ç«™ï¼Œä¸€ä¸ªå‰ç«¯ä¸€ä¸ªåç«¯

![image-20230504195925255](http://pic.user-center.xyz/images/2023/05/06/image-20230504195925255.png)



![image-20230504200042327-1683201644859-2](http://pic.user-center.xyz/images/2023/05/06/image-20230504200042327-1683201644859-2.png)

```bash
location ^~ /api/ {
        
        add_header 'Access-Control-Allow-Origin' $http_origin;
        add_header 'Access-Control-Allow-Credentials' 'true';
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
        add_header Access-Control-Allow-Headers '*';
    
        if ($request_method = 'OPTIONS') {
         add_header 'Access-Control-Allow-Credentials' 'true';
         add_header 'Access-Control-Allow-Origin' $http_origin;
         add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
         add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
         add_header 'Access-Control-Max-Age' 1728000;
         add_header 'Content-Type' 'text/plain; charset=utf-8';
         add_header 'Content-Length' 0;
            return 204;
        }
          proxy_pass http://127.0.0.1:8082;
    }
```



æ¥ä¸‹æ¥è®¿é—®å‰ç«¯ç½‘ç«™å³å¯ï¼Œè‡³æ­¤ï¼Œé¡¹ç›®å·²æˆåŠŸä¸Šçº¿
